<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maestro Solution - Inteligencia Agr铆cola</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAvCV-iDy3s-eV5693z6RUKLkL2eMKJUNg",
            authDomain: "maestro-solution.firebaseapp.com",
            projectId: "maestro-solution",
            storageBucket: "maestro-solution.firebasestorage.app",
            messagingSenderId: "676315384684",
            appId: "1:676315384684:web:f2422750ef5f430e2f4149"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let myChart;
        let datosOriginalesMonitoreo = [];
        let datosOriginalesUsuarios = [];

        // --- ESCUCHADORES DE FIREBASE ---
        onSnapshot(query(collection(db, "monitoreos"), orderBy("fecha", "desc")), (snapshot) => {
            datosOriginalesMonitoreo = snapshot.docs.map(doc => doc.data());
            aplicarFiltros();
        });

        onSnapshot(collection(db, "usuarios"), (snapshot) => {
            datosOriginalesUsuarios = snapshot.docs.map(doc => doc.data());
            renderizarUsuarios(datosOriginalesUsuarios);
            actualizarSelectores(datosOriginalesUsuarios);
        });

        // --- LGICA DE FILTROS ---
        window.aplicarFiltros = () => {
            const predioF = document.getElementById("f-predio").value;
            const comunaF = document.getElementById("f-comuna").value;

            const filtrados = datosOriginalesMonitoreo.filter(d => {
                return (predioF === "Todos" || d.predio === predioF) &&
                       (comunaF === "Todas" || d.comuna === comunaF);
            });

            renderizarMonitoreo(filtrados);
        };

        function actualizarSelectores(usuarios) {
            const selP = document.getElementById("f-predio");
            const selC = document.getElementById("f-comuna");
            const predios = [...new Set(usuarios.map(u => u.predio))];
            const comunas = [...new Set(usuarios.map(u => u.comuna))];

            selP.innerHTML = '<option value="Todos">Todos los Predios</option>' + predios.map(p => `<option value="${p}">${p}</option>`).join('');
            selC.innerHTML = '<option value="Todas">Todas las Comunas</option>' + comunas.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function renderizarMonitoreo(datos) {
            const tabla = document.getElementById("datos-monitoreo");
            tabla.innerHTML = "";
            const labels = [];
            const valores = [];

            datos.forEach(d => {
                const fecha = d.fecha ? d.fecha.toDate().toLocaleDateString() : "S/F";
                tabla.innerHTML += `<tr><td>${fecha}</td><td>${d.predio}</td><td>${d.comuna}</td><td>${d.cuartel}</td><td><span class="badge ${d.promedio > 5 ? 'bg-red' : 'bg-green'}">${d.promedio}</span></td></tr>`;
                labels.unshift(fecha);
                valores.unshift(d.promedio);
            });
            updateChart(labels, valores);
        }

        function renderizarUsuarios(datos) {
            const tabla = document.getElementById("datos-usuarios");
            tabla.innerHTML = datos.map(u => `<tr><td>${u.propietario}</td><td>${u.predio}</td><td>${u.region}</td><td>${u.comuna}</td><td>${u.cuarteles?.length || 0}</td></tr>`).join('');
        }

        // --- EXPORTACIN ---
        window.exportExcel = () => {
            const wb = XLSX.utils.book_new();
            const wsMon = XLSX.utils.json_to_sheet(datosOriginalesMonitoreo.map(d => ({...d, fecha: d.fecha?.toDate()})));
            XLSX.utils.book_append_sheet(wb, wsMon, "Monitoreos");
            const wsUser = XLSX.utils.json_to_sheet(datosOriginalesUsuarios.map(u => ({...u, cuarteles: u.cuarteles?.length})));
            XLSX.utils.book_append_sheet(wb, wsUser, "Propietarios");
            XLSX.writeFile(wb, "Reporte_MaestroSolution.xlsx");
        };

        window.exportPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Reporte Maestro Solution", 14, 15);
            doc.autoTable({ html: '#tabla-mon-pdf', startY: 25 });
            doc.save("Reporte_MaestroSolution.pdf");
        };

        function updateChart(labels, data) {
            const ctx = document.getElementById('evolucionChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: 'Presi贸n', data, borderColor: '#2e7d32', tension: 0.4 }] } });
        }
    </script>

    <style>
        :root { --primary: #1b5e20; --bg: #f4f7f6; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; display: flex; }
        .sidebar { width: 240px; background: var(--primary); height: 100vh; color: white; padding: 20px; position: fixed; }
        .main { margin-left: 260px; padding: 20px; width: 100%; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .filters { display: flex; gap: 15px; margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 8px; }
        select, .btn { padding: 10px; border-radius: 5px; border: 1px solid #ddd; }
        .btn { cursor: pointer; border: none; font-weight: bold; color: white; transition: 0.3s; }
        .btn-excel { background: #2e7d32; }
        .btn-pdf { background: #c62828; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .badge { padding: 4px 8px; border-radius: 12px; color: white; font-size: 0.8em; }
        .bg-red { background: #d32f2f; }
        .bg-green { background: #388e3c; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>MAESTRO</h2><p>Solution v2.0</p><hr>
        <p> Dashboard</p>
        <button class="btn btn-excel" onclick="exportExcel()" style="width: 100%; margin-bottom: 10px;">Excel</button>
        <button class="btn btn-pdf" onclick="exportPDF()" style="width: 100%;">PDF</button>
    </div>

    <div class="main">
        <h1>Panel de Inteligencia Agr铆cola</h1>
        
        <div class="filters">
            <select id="f-predio" onchange="aplicarFiltros()"></select>
            <select id="f-comuna" onchange="aplicarFiltros()"></select>
        </div>

        <div class="grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
            <div class="card">
                <h3>Evoluci贸n de Presi贸n</h3>
                <canvas id="evolucionChart"></canvas>
            </div>
            <div class="card">
                <h3>ltimos Monitoreos</h3>
                <div style="height: 300px; overflow-y: auto;">
                    <table id="tabla-mon-pdf">
                        <thead><tr><th>Fecha</th><th>Predio</th><th>Comuna</th><th>Cuartel</th><th>Prom.</th></tr></thead>
                        <tbody id="datos-monitoreo"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Base de Datos Propietarios</h3>
            <table>
                <thead><tr><th>Due帽o</th><th>Predio</th><th>Regi贸n</th><th>Comuna</th><th>Cuarteles</th></tr></thead>
                <tbody id="datos-usuarios"></tbody>
            </table>
        </div>
    </div>
</body>
</html>